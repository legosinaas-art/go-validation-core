## Migrant ID Service

Небольшой учебно-прикладной сервис на Go для выдачи и проверки цифровых ID мигранта.
Сервис генерирует JWT-токен, QR‑код, хранит выданные токены в памяти и позволяет проверять их валидность (через HTML-форму и JSON API).

### Технологии

- Go (стандартная библиотека)
- Gin (`github.com/gin-gonic/gin`) — HTTP‑роутер и мидлвары
- JWT (`github.com/golang-jwt/jwt/v5`)
- QR-коды (`github.com/skip2/go-qrcode`)

---

## Структура проекта

```text
cmd/
  main.go          — точка входа, сборка зависимостей и запуск HTTP‑сервера
  server.go        — обёртка над http.Server (таймауты, запуск/остановка)

configs/
  config.go        — загрузка .env и переменных окружения, структура Config

internal/
  domain/
    models.go      — доменные модели (запрос, токен, ответ)

  http/
    handler/
      handler.go       — базовый handler + инициализация HTML‑шаблонов
      issue_api.go     — API для выдачи ID и QR
      validate_api.go  — API для проверки ID
      web_check.go     — HTML‑страницы проверки
      web_issue.go     — HTML‑страницы выдачи

    router/
      router.go    — инициализация Gin и регистрация всех маршрутов

  repository/
    repo.go           — интерфейс Repository и in‑memory реализация
    save_token.go     — сохранение токена
    get_by_id.go      — получение токена по PassportID

  service/
    service.go           — MigrantService и его зависимости
    create_qr.go         — выдача ID: генерация JWT и QR‑кода
    validate.go          — валидация токена/JWT
    check_by_id.go       — mock‑проверка в условных гос‑сервисах
    GetTokenByPassport.go — прокси к репозиторию

framework/
  shortenToken.go   — утилита для сокращения длинного токена для UI

templates/
  *.html            — HTML‑шаблоны (формы выдачи/проверки и результат)
```

---

## Конфигурация

Сервис читает конфиг через `configs.Load()`. Источники (по порядку):

1. Локальный файл `.env` в корне проекта (если существует).
2. Переменные окружения процесса (не перезаписываются значениями из `.env`).

Поддерживаемые переменные:

- `PORT` — порт HTTP‑сервера (по умолчанию `8080`).
- `JWT_SECRET` — секретный ключ для подписи JWT.
  - **Обязательно** переопредели в продакшене, локально можно оставить дефолт.
- `TEMPLATES_DIR` — директория с HTML‑шаблонами (по умолчанию `templates`).

Пример `.env` (создать вручную в корне репозитория):

```env
PORT=8080
JWT_SECRET=super-strong-random-secret
TEMPLATES_DIR=templates
```

---

## Установка и запуск

### 1. Клонирование

```bash
git clone <URL_ВАШЕГО_РЕПОЗИТОРИЯ> validation-core
cd validation-core
```

### 2. Зависимости

Модуль уже настроен, достаточно:

```bash
go mod tidy
```

### 3. Конфигурация

Создай файл `.env` (см. пример выше) **или** выставь переменные окружения другим способом.
Минимально для запуска достаточно задать `JWT_SECRET` (иначе будет использовано небезопасное значение по умолчанию, что годится только для локальной разработки).

### 4. Запуск в dev‑режиме

```bash
go run ./cmd/...
```

По умолчанию сервер поднимается на `http://localhost:8080` (или на порту из `PORT`).

### 5. Сборка бинарника

```bash
go build -o validation-core ./cmd/...

# запуск собранного бинарника
./validation-core
```

---

## Основные маршруты

### Web (HTML)

- `GET /` — форма проверки токена.
- `GET /check/result?token=...` — страница с результатом проверки.
- `GET /issue` — форма выдачи ID (ввод паспортных данных).
- `POST /issue/process` — обработка формы выдачи, показ QR и токена.

### API (JSON)

- `GET /api/validate?token=...`  
  Проверка токена.  
  Ответ:
  ```json
  {
    "is_valid": true,
    "message": "ДОКУМЕНТ ПОДЛИННЫЙ. Доступ разрешен.",
    "name": "Имя Фамилия",
    "expires_at": "02 Jan 06 15:04 MST"
  }
  ```

- `POST /api/issue`  
  Выдача нового ID. Тело запроса (JSON):
  ```json
  {
    "passport_id": "1234567890",
    "full_name": "Имя Фамилия"
  }
  ```
  Пример ответа:
  ```json
  {
    "token": "jwt-token-here",
    "expires_at": "02 Jan 06 15:04 MST",
    "qr_code_image_url": "/api/qr/1234567890"
  }
  ```

- `GET /api/qr/:passportID`  
  Возвращает PNG‑картинку QR‑кода для выданного токена (если токен найден).

---

## Как это работает в целом

1. Пользователь или внешний сервис отправляет данные (`passport_id`, `full_name`) на `/api/issue` или через HTML‑форму.
2. `MigrantService`:
   - проверяет паспорт через `CheckGos` (mock‑проверка),
   - убеждается, что токен ещё не выдавали,
   - создаёт JWT с данными и сроком действия,
   - генерирует QR‑код для этого токена,
   - сохраняет результат в in‑memory репозитории.
3. Для проверки инспектор/клиент отправляет токен на `/api/validate` или через веб‑форму `/`.
4. Сервис валидирует подпись JWT, срок действия и повторно проверяет статус через `CheckGos`.

Всё хранение пока в памяти процесса (подходит для демо/POC). Для реального продакшена можно заменить `internal/repository` на реализацию поверх БД, не трогая остальной код.



